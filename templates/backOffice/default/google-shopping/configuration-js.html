{default_translation_domain domain='googleshopping.ai'}

{javascripts file='assets/js/bootstrap-switch/bootstrap-switch.js'}
  <script src='{$asset_url}'></script>
{/javascripts}

<script>
  $(function() {
    $("#search-taxonomy").keyup(function(){
      search = $(this).val();
      if (search.length > 2) {
        $.get('{url path="/admin/module/googleshopping/taxonomy/{$edit_language_id}"}', function(data) {
          var res = "";
          $.each(data.cats, function(k, v) {
            var searchUp = search.toUpperCase();
            var linesUp = k.toUpperCase();
            if (-1 !== linesUp.search(searchUp)) {
              res += '<option value="'+v+'">'+k+'</option>';
            }
          });
          $("#google-taxonomy").html(res);
        })
      }
    });

    $(".check-all-gtin").click(function(event) {
      var catId = $(this).data("category");
      if(this.checked) {
        $('.check-gtin-'+catId).each(function() {
          this.checked = true;
        });
      } else {
        $('.check-gtin-'+catId).each(function() {
          this.checked = false;
        });
      }
    });

    $(".check-gtin").click(function(event) {
      var prodId = $(this).data("id");
      if(this.checked) {
        $('#gtin-product-'+prodId).val('on')
      } else {
        $('#gtin-product-'+prodId).val('off');
      }
    });

    $(".check-all-product").click(function(event) {
      var catId = $(this).data("category");
      if(this.checked) {
        $('.check-product-'+catId).each(function() {
          this.checked = true;
        });
      } else {
        $('.check-product-'+catId).each(function() {
          this.checked = false;
        });
      }
    });

    $(".send-checked").click(function (event) {
      var catId = $(this).data("category");
      $('.check-product-'+catId+':checked').each(function() {
        var productId = $(this).data("product");
        $(".td-product-"+productId+":first").html('<span class="loading" style="margin:auto"></span>');
        var form = $("#add-form-product-"+productId);
        form.append("<input type='hidden' name='ajax' value='true'>");
        $.ajax({
          url: form.attr('action'),
          type: form.attr('method'),
          data: form.serialize()
        }).fail(function(jqXHR, textStatus, errorThrown) {
          $(".td-product-" + productId).remove();
          $("#tr-product-"+productId).addClass("danger").append("<td colspan='2'>"+jqXHR.responseText+"</td>");
        }).done(function(data){
          $(".td-product-" + productId).remove();
          $("#tr-product-"+productId).addClass("success").append("<td colspan='2'>{intl l="Product add with success"}</td>");
        })
      });
    });

    $("#select-country").change(function (event) {
      window.location.href = $(this).val();
    });


    $(".tr-product").each(function() {
      var productId = $(this).data("product");
      var form = $("#add-form-product-"+productId);
      var tr = $(this);
      var url = "{url path="/admin/module/googleshopping/get/"}"+productId;

      $.ajax({
        url: url,
        type: form.attr('method'),
        data: form.serialize()
      }).done(function(data){
        if (data.id) {
          tr.addClass("success");

          if (data.identifier == false) {
            $("#td-gtin-product-"+productId).html("{intl l="Product no GTIN"}");
            $("#gtin-product-"+productId).val("on");
          }

          $("#delete-form-product-"+productId).show().addClass("col-md-6");
          $("#add-form-product-"+productId).children("button").html("{intl l="Update"}");
          $("#add-form-product-"+productId).addClass("col-md-6");

          $("#td-exist-"+productId).show();
        }
      })
    });

    $(".sync-switch").bootstrapSwitch();

    $(".sync-switch").on("switch-change", function(e, data) {
      var productId = $(this).data("product");
      var form = $("#add-form-product-"+productId);
      var url = "{url path="/admin/module/googleshopping/toggle/sync/"}"+productId;
      $('body').append('<div class="modal-backdrop fade in" id="loading-event"><div class="loading"></div></div>');
      $.ajax({
        url: url,
        type: form.attr('method'),
        data: form.serialize()
      }).done(function(data){
        $("#loading-event").remove();
      })
    });
  })
</script>