{extends file="admin-layout.tpl"}

{block name="no-return-functions"}
    {$admin_current_location = 'modules'}
{/block}

{block name="page-title"}{intl l='GoogleShopping'}{/block}

{block name="main-content"}
    {oAuthCheckToken}
    {default_translation_domain domain='googleshopping.bo.default'}
    {if 'none' === $tokenExist}
        <h4>{intl l="You have to authorise this site on GoogleShopping before adding products :"}</h4>
        <div class="form-group col-md-12">
            <div class="form-group">
                <form action="{url path='/googleshopping/oauth2callback'}" method="get">
                    <input type="hidden" name="redirect" value="{url path={navigate to="current"}}"/>
                    <button class="btn btn-default btn-primary form-control" type="submit">
                        <span class="glyphicon glyphicon-check"></span>
                        {intl l="Authorize"}
                    </button>
                </form>
            </div>
        </div>
    {elseif true === $tokenExpired}
        <h4>{intl l="Your authorisation expired please refresh it before adding products :"}</h4>
        <div class="form-group col-md-12">
            <div class="form-group">
                <form action="{url path='/googleshopping/oauth2callback'}" method="get">
                    <input type="hidden" name="redirect" value="{url path={navigate to="current"}}"/>
                    <button class="btn btn-default btn-primary form-control" type="submit">
                        <span class="glyphicon glyphicon-check"></span>
                        {intl l="Refresh"}
                    </button>
                </form>
            </div>
        </div>
    {else}
        {loop type="category" name="category" id="$categoryId"}

            <div id="wrapper" class="container">
            <div class="clearfix">
                <ul class="breadcrumb pull-left">
                    <li><a href="{url path='/admin/home'}">{intl l="Home"}</a></li>
                    <li><a href="{url path='/admin/modules'}">{intl l="Modules"}</a></li>
                    <li>
                        <a href="{url path="/admin/module/GoogleShopping" current_tab="management"}">{intl l="Configure"}
                            : GoogleShopping</a></li>
                    <li><a href="#">{$TITLE}</a></li>
                </ul>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading js-hash-product-category-{$categoryId}">
                    <h4 class="panel-title">
                        {intl l="Choose merchant account and country before export :"}
                    </h4>

                    <div class="row inner-toolbar{if $page_bottom} inner-toolbar-bottom{/if}">
                        <div class="col-md-3 inner-actions">
                            {loop name="lang_list" type="lang" id=$langId}
                                <label for="lang">{intl l="Current language of exportation"}</label>
                                <input id="lang" class="form-control" type="text" readonly value="{$TITLE}">
                            {/loop}
                        </div>
                        <div class="col-md-3 inner-actions">
                            <label for="select-account">{intl l="Merchant account"}</label>
                            <select id="select-account" class="form-control" name="{$name}">
                                <option>
                                    {intl l="Choose merchant account"}
                                </option>
                                {loop type="googleshopping.merchant.account" name="googleshopping.merchant.account"}
                                    <option value="{$MERCHANT_ID}" data-country="{$DEFAULT_COUNTRY_ID}" data-currency="{$DEFAULT_CURRENCY_ID}">
                                        {$MERCHANT_ID}
                                    </option>
                                {/loop}
                            </select>
                        </div>
                        <div class="col-md-3 inner-actions">
                            <label for="select-country">{intl l="Target country"}</label>
                            <select id="select-country" class="form-control" name="{$name}">
                                <option>
                                    {intl l="Choose target country"}
                                </option>
                                {loop type="country" name="country-select"}
                                    <option value="{$ID}">
                                        {$TITLE}
                                    </option>
                                {/loop}
                            </select>
                        </div>
                        <div class="col-md-3 inner-actions">
                            <label for="select-currency">{intl l="Currency"}</label>
                            <select id="select-currency" class="form-control" name="{$name}">
                                <option>
                                    {intl l="Choose currency"}
                                </option>
                                {loop type="currency" name="currency-select"}
                                    <option value="{$ID}">
                                        {$SYMBOL}
                                    </option>
                                {/loop}
                            </select>
                        </div>
                    </div>
                </div>
                <div style="display: none;" id="product-category">
                    <div class="panel-body">
                        {ifloop rel="googleshopping_product"}
                            <table class="table table-striped table-condensed table-left-aligned">
                                <thead>
                                <tr>
                                    <th class="object-title">
                                        {admin_sortable_header
                                        current_order=$smarty.get.product_order
                                        order='id'
                                        reverse_order='id_reverse'
                                        path={url path={navigate to="current"} current_cat=$categoryId}
                                        request_parameter_name='product_order'
                                        label={intl l='ID'}
                                        }
                                    </th>

                                    <th class="object-title">
                                        {admin_sortable_header
                                        current_order=$smarty.get.product_order
                                        order='ref'
                                        reverse_order='ref_reverse'
                                        path={url path={navigate to="current"} current_cat=$categoryId}
                                        request_parameter_name='product_order'
                                        label={intl l='Ref'}
                                        }
                                    </th>

                                    <th class="object-title">
                                        {admin_sortable_header
                                        current_order=$smarty.get.product_order
                                        order='ean'
                                        reverse_order='ean_reverse'
                                        path={url path={navigate to="current"} current_cat=$categoryId}
                                        request_parameter_name='product_order'
                                        label={intl l='GTIN'}
                                        }
                                        <input class="check-all-gtin" data-category="{$categoryId}" type="checkbox"/>
                                    </th>

                                    <th class="object-title">
                                        {admin_sortable_header
                                        current_order=$smarty.get.product_order
                                        order='alpha'
                                        reverse_order='alpha_reverse'
                                        path={url path={navigate to="current"} current_cat=$categoryId}
                                        request_parameter_name='product_order'
                                        label={intl l='Title'}
                                        }
                                    </th>

                                    <th class="text-center">
                                        <input class="check-all-product" data-category="{$categoryId}" type="checkbox"/>
                                    </th>
                                    <th class="text-center">
                                        <button class="send-checked btn btn-default btn-success btn-sm form-control"
                                                data-category="{$categoryId}"
                                                class="btn btn-default btn-success btn-xs form-control" type="submit">
                                            {intl l="Send checked"}
                                        </button>
                                    </th>
                                    <th class="text-center">
                                        {intl l="Synchronisation"}
                                    </th>
                                </tr>
                                </thead>
                                <tbody>
                                {loop type="googleshopping.product" name="googleshopping_product" category_id={$categoryId} locale={$edit_language_locale} country={$smarty.get.target_country} product_order=$smarty.get.product_order}
                                {$SYNC_ENABLE = false}
                                    <tr class="tr-product" data-product="{$ID}" id="tr-product-{$ID}">
                                        <td>{$ID}</td>
                                        <td>
                                            <a href="{url path="/admin/products/update?product_id=%product_id" product_id=$ID}">{$REF}</a>
                                        </td>
                                        <td id="td-gtin-product-{$ID}">{if $VALID_EAN === false}
                                                {intl l="Error At least one GTIN is empty."}
                                                <br/>
                                                <input class="check-gtin check-gtin-{$categoryId}" data-id="{$ID}" type="checkbox" name="gtin"/>
                                                {intl l="This product don't have GTIN."}
                                            {else}
                                                {intl l="GTIN ok"}
                                            {/if}
                                        </td>
                                        <td>{$TITLE}</td>
                                        <td class="text-center td-product-{$ID} td-not-exist-{$ID}">
                                            <input class="check-product" type="checkbox" data-product="{$ID}" name="products[{$ID}][checkbox]"/>
                                        </td>
                                        <td class="text-center td-product-{$ID} td-not-exist-{$ID}">
                                            <form class="ajax-form" id="add-form-product-{$ID}" action="/admin/module/googleshopping/add/{$ID}" method="post">
                                                <input class="product_account" type="hidden" name="account">
                                                <input class="product_country" type="hidden" name="country">
                                                <input class="product_currency" type="hidden" name="currency">
                                                <input type="hidden" name="lang" value="{$langId}">
                                                <input type="hidden" name="gtin" id="gtin-product-{$ID}"/>
                                                <button class="btn btn-default btn-primary btn-sm form-control"
                                                        type="submit">
                                                    {intl l="Send"}
                                                </button>
                                            </form>
                                            <form class="ajax-form" id="delete-form-product-{$ID}" action="/admin/module/googleshopping/delete/{$ID}" method="post" style="display: none">
                                                <input class="product_account" type="hidden" name="account">
                                                <input class="product_country" type="hidden" name="country">
                                                <input class="product_currency" type="hidden" name="currency">
                                                <input type="hidden" name="lang" value="{$langId}">
                                                <input type="hidden" name="gtin" id="gtin-product-{$ID}"/>
                                                <button class="btn btn-default btn-danger btn-sm form-control" type="submit">{intl l="Delete"}</button>
                                            </form>
                                        </td>
                                        <td class="text-center">
                                            <div class="switch-small sync-switch" readonly="true" data-on="success" data-off="danger"
                                                 data-product="{$ID}" data-lang="{$langId}"
                                                 data-country="{$smarty.get.target_country}"
                                                 data-on-label="<i class='glyphicon glyphicon-ok-circle'></i>"
                                                 data-off-label="<i class='glyphicon glyphicon-remove-circle'></i>">

                                                {loop type="googleshopping.product.sync" name="googleshopping_product_sync" product_id={$ID} country={$smarty.get.target_country} locale={$edit_language_locale} }
                                                {if $ENABLE}
                                                    {$SYNC_ENABLE = true}
                                                {/if}
                                                {/loop}

                                                <input type="checkbox" disabled readonly name="sync" value="true" {if $SYNC_ENABLE === true}checked{/if}/>
                                            </div>
                                        </td>
                                    </tr>
                                {/loop}
                                </tbody>
                            </table>
                        {/ifloop}
                        {elseloop rel="googleshopping_product"}
                            <div class="panel-body panel-warning">
                                <div class="panel-heading js-hash-product-category-{$categoryId}">
                                    <p>{intl l="Warning : No one products have this category on default category"}</p>
                                </div>
                            </div>
                        {/elseloop}
                    </div>
                </div>
            </div>
        {/loop}
        </div>
    {/if}
    <div id="alert" style="position: fixed; top: 0px; z-index: 1000; margin: 0 auto;">

    </div>
{/block}

{block name="javascript-initialization"}

    {javascripts file='assets/js/bootstrap-switch/bootstrap-switch.js'}
        <script src='{$asset_url}'></script>
    {/javascripts}
    <script>
        $("#select-account").change(function (event) {
            var countryId = $("#select-account option:selected").data("country");
            var currencyId = $("#select-account option:selected").data("currency");
            var accountId = $(this).val();
            $('#select-country option[value="'+countryId+'"]').prop('selected', true);
            $('#select-currency option[value="'+currencyId+'"]').prop('selected', true);

            $(".product_account").each(function(){
                $(this).val(accountId);
            });
            $(".product_country").each(function(){
                $(this).val(countryId);
            });
            $(".product_currency").each(function(){
                $(this).val(currencyId);
            });

            $("#product-category").show();

            searchGoogleProducts();
        });

        $("#select-country").change(function (event) {
           var countryId = $(this).val();
            $(".product_country").each(function(){
                $(this).val(countryId);
            });

            searchGoogleProducts();
        });

        $("#select-currency").change(function (event) {
           var currencyId = $(this).val();
            $(".product_currency").each(function(){
                $(this).val(currencyId);
            });

            searchGoogleProducts();
        });

        $(".ajax-form").submit(function (event) {
            event.preventDefault();
            var form = $(this);
            var btn = form.find('button[type="submit"]');
            var btnHtml = btn.html();
            btn.addClass('disabled').html('{intl l="Please wait..."} <span class="glyphicon glyphicon-hourglass"></span>');
            $.ajax({
                url: form.attr('action'),
                type: form.attr('method'),
                data: form.serialize()
            }).done(function(data){
                $("#alert").html('<div class="alert alert-success"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+data.message+'</div>');
                btn.removeClass('disabled').html(btnHtml);
            }).fail(function(jqXHR, textStatus ){
                $("#alert").html('<div class="alert alert-danger"><button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+jqXHR.responseText+'</div>');
                btn.removeClass('disabled').html(btnHtml);
            });
        });

        $(".check-all-gtin").click(function (event) {
            var catId = $(this).data("category");
            if (this.checked) {
                $('.check-gtin-' + catId).each(function () {
                    this.checked = true;
                });
            } else {
                $('.check-gtin-' + catId).each(function () {
                    this.checked = false;
                });
            }
        });

        $(".check-gtin").click(function (event) {
            var prodId = $(this).data("id");
            if (this.checked) {
                $('#gtin-product-' + prodId).val('on')
            } else {
                $('#gtin-product-' + prodId).val('off');
            }
        });

        $(".check-all-product").click(function (event) {
            var catId = $(this).data("category");
            if (this.checked) {
                $('.check-product-' + catId).each(function () {
                    this.checked = true;
                });
            } else {
                $('.check-product-' + catId).each(function () {
                    this.checked = false;
                });
            }
        });

        $(".send-checked").click(function (event) {
            $('.check-product:checked').each(function () {
                var productId = $(this).data("product");
                $(".td-product-" + productId + ":first").html('<span class="loading" style="margin:auto"></span>');
                var form = $("#add-form-product-" + productId);
                $.ajax({
                    url: form.attr('action'),
                    type: form.attr('method'),
                    data: form.serialize()
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    $(".td-product-" + productId).remove();
                    $("#tr-product-" + productId).addClass("danger").append("<td colspan='2'>" + jqXHR.responseText + "</td>");
                }).done(function (data) {
                    $(".td-product-" + productId).remove();
                    $("#tr-product-" + productId).addClass("success").append("<td colspan='2'>{intl l="Product add with success"}</td>");
                })
            });
        });

        function searchGoogleProducts() {
            $(".tr-product").each(function () {
                var productId = $(this).data("product");
                var form = $("#add-form-product-" + productId);
                var tr = $(this);
                var url = "{url path="/admin/module/googleshopping/get/"}" + productId;

                $.ajax({
                    url: url,
                    method: 'GET',
                    data: form.serialize()
                }).done(function (data) {
                    if (data.id) {
                        tr.addClass("success");

                        if (data.identifier == false) {
                            $("#td-gtin-product-" + productId).html("{intl l="Product no GTIN"}");
                            $("#gtin-product-" + productId).val("on");
                        }

                        $("#delete-form-product-" + productId).show().addClass("col-md-6");
                        $("#add-form-product-" + productId).children("button").html("{intl l="Update"}");
                        $("#add-form-product-" + productId).addClass("col-md-6");

                        $("#td-exist-" + productId).show();
                    }
                })
            });
        }

        $(".sync-switch").bootstrapSwitch();

        $(".sync-switch").on("switch-change", function (e, data) {
            var productId = $(this).data("product");
            var form = $("#add-form-product-" + productId);
            var url = "{url path="/admin/module/googleshopping/toggle/sync/"}" + productId;
            $('body').append('<div class="modal-backdrop fade in" id="loading-event"><div class="loading"></div></div>');
            $.ajax({
                url: url,
                type: form.attr('method'),
                data: form.serialize()
            }).done(function (data) {
                $("#loading-event").remove();
            })
        });
    </script>
{/block}

{block name="javascript-last-call"}

{/block}