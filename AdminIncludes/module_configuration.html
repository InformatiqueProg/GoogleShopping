{default_translation_domain domain='googleshopping.ai'}
{assign var="tab" value="configuration"}
{if isset($smarty.get.current_tab)}
    {assign var="tab" value=$smarty.get.current_tab}
{/if}
{if isset($smarty.get.current_cat)}
    {assign var="curr_cat" value=$smarty.get.current_cat}
{/if}
{oAuthCheckToken}
<div class="general-block-decorator">
    <div class="row">
        <div class="col-md-12">
            <ul id="tabbed-menu" class="nav nav-tabs">
                <li class="{if $tab eq "configuration"}active{/if}"><a data-toggle="tab" href="#configuration">{intl l="Configuration"}</a> </li>
                <li class="{if $tab eq "association"}active{/if}"><a data-toggle="tab" href="#association">{intl l="Google Categories Associations"}</a></li>
                <li class="{if $tab eq "management"}active{/if}"><a data-toggle="tab" href="#management">{intl l="Catalog management"}</a></li>
            </ul>

            <div class="tab-content">
                <div id="configuration" class="tab-pane {if $tab eq "configuration"}active{/if} form-container">
                    <div class="panel panel-default">
                        {form name="googleshopping.api.configuration"}
                            <form method="post" action='{url path="/admin/module/googleshopping/api/configuration"}'>
                                <div class="panel-heading">
                                    <h4>{intl l="Google Api configuration"}</h4>
                                    {include
                                    file      = "includes/inner-form-toolbar.html"
                                    hide_flags = true
                                    close_url = {url path='/admin/modules'}
                                    }
                                </div>
                                <div class="panel-body">
                                    {form_hidden_fields form=$form}
                                    <div class="col-md-12">
                                        <div class="row">
                                            {form_field form=$form field="application_name"}
                                                <div class="form-group col-md-6 {if $error}has-error{/if}">
                                                    <label for="{$label_attr.for}">{$label}</label>
                                                    <input id="{$label_attr.for}" class="form-control"  name="{$name}" value="{$value}" required/>
                                                    <span class="help-block">{intl l="The application name you have define when you have create the api apllication "}</span>
                                                </div>
                                            {/form_field}

                                            {form_field form=$form field="client_id"}
                                                <div class="form-group col-md-6 {if $error}has-error{/if}">
                                                    <label for="{$label_attr.for}">{$label}</label>
                                                    <input id="{$label_attr.for}" class="form-control" type="text" name="{$name}" value="{$value}" required/>
                                                    <span class="help-block">{intl l="The client ID of the api who can be found in https://console.developers.google.com at APIs & auth > Credentials"}</span>
                                                </div>
                                            {/form_field}

                                            {form_field form=$form field="client_secret"}
                                                <div class="form-group col-md-6 {if $error}has-error{/if}">
                                                    <label for="{$label_attr.for}">{$label}</label>
                                                    <input id="{$label_attr.for}" class="form-control"  type="text" name="{$name}" value="{$value}" required/>
                                                    <span class="help-block">{intl l="The client secret associate to client ID"}</span>
                                                </div>
                                            {/form_field}
                                        </div>
                                    </div>
                                </div>
                            </form>
                        {/form}
                    </div>
                    <div class="panel panel-default">
                        {form name="googleshopping.merchant.configuration"}
                            <form method="post" action='{url path="/admin/module/googleshopping/merchant/configuration"}'>
                                <div class="panel-heading">
                                    <h4>{intl l="Google Merchant configuration"}</h4>

                                    {include
                                    file      = "includes/inner-form-toolbar.html"
                                    hide_flags = true
                                    close_url = {url path='/admin/modules'}
                                    }
                                </div>
                                <div class="panel-body">

                                    {form_hidden_fields form=$form}
                                    <div class="col-md-12">
                                        <div class="row">
                                            {form_field form=$form field="merchant_id"}
                                                <div class="form-group col-md-6 {if $error}has-error{/if}">
                                                    <label for="{$label_attr.for}">{$label}</label>
                                                    <input id="{$label_attr.for}" class="form-control"  name="{$name}" value="{$value}" required/>
                                                    <span class="help-block">{intl l="Your google merchant ID, can be found in Google Merchant center"}</span>
                                                </div>
                                            {/form_field}

                                            {form_field form=$form field="target_country_id"}
                                                <div class="form-group col-md-6 {if $error}has-error{/if}">
                                                    <label for="{$label_attr.for}">{$label}</label>
                                                    <select id="{$label_attr.for}" class="form-control"  name="{$name}">
                                                        {loop type="country" name="target_country"}
                                                            <option value="{$ID}" {if $value == $ID}selected{/if} >{$TITLE}</option>
                                                        {/loop}
                                                    </select>
                                                    <span class="help-block">{intl l="The target country for Google Shopping"}</span>
                                                </div>
                                            {/form_field}

                                            {form_field form=$form field="attribute_color"}
                                                <div class="form-group col-md-6 {if $error}has-error{/if}">
                                                    <label for="{$label_attr.for}">{$label}</label>
                                                    <input id="{$label_attr.for}" class="form-control"  name="{$name}" value="{$value}" />
                                                    <span class="help-block">{intl l="The ID of thelia color attributes if you have one"}</span>
                                                </div>
                                            {/form_field}

                                            {form_field form=$form field="attribute_size"}
                                                <div class="form-group col-md-6 {if $error}has-error{/if}">
                                                    <label for="{$label_attr.for}">{$label}</label>
                                                    <input id="{$label_attr.for}" class="form-control"  name="{$name}" value="{$value}" />
                                                    <span class="help-block">{intl l="The ID of thelia size attributes if you have one"}</span>
                                                </div>
                                            {/form_field}
                                        </div>
                                    </div>
                                </div>
                            </form>
                        {/form}
                    </div>
                </div>

                <div id="association" class="tab-pane {if $tab eq "association"}active{/if} form-container">
                    <div class="panel panel-default">
                        <div class="panel-heading clearfix">
                        </div>
                        <div class="panel-body">
                            {form name="googleshopping.taxonomy"}
                                <form action="{url path="/admin/modules/googleshopping/taxonomy/associate"}" method="post">
                                    {form_hidden_fields form=$form}

                                    <div class="col-md-12">
                                        <div class="row">
                                            <div class="form-group col-md-3">
                                                {form_field form=$form field="thelia_category_id"}
                                                    <label for="thelia-category">{intl l="Thelia category"}</label>
                                                    <select id="thelia-category" class="form-control" name="{$name}">
                                                        {loop type="category" name="thelia-category"}
                                                            <option value="{$ID}">{$TITLE}</option>
                                                        {/loop}
                                                    </select>
                                                {/form_field}
                                            </div>
                                            <div class="form-group col-md-3">
                                                <label for="search-taxonomy">{intl l="Search category (English only)"}</label>
                                                <div class="input-group">
                                                    <input class="form-control" type="text" id="search-taxonomy"/>
                                            <span class="input-group-addon">
                                                <span class="glyphicon glyphicon-arrow-right"></span>
                                            </span>
                                                </div>
                                            </div>
                                            <div class="form-group col-md-3">
                                                {form_field form=$form field="google_category"}
                                                    <label for="google-taxonomy">{intl l="Google Category"}</label>
                                                    <select class="form-control" name="{$name}" id="google-taxonomy">

                                                    </select>
                                                {/form_field}
                                            </div>
                                            <div class="form-group col-md-3">
                                                <label class="control-label">&nbsp;</label>
                                                <button class="btn btn-default btn-primary form-control" type="submit">
                                                    <span class="glyphicon glyphicon-check"></span>
                                                    {intl l="Associate"}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            {/form}
                            <div class="table-responsive col-md-12">
                                <table class="table table-striped table-condensed table-left-aligned">
                                    <caption class="clearfix">
                                        {intl l="GoogleShopping associated categories"}
                                    </caption>
                                    {loop type="googleshopping.category.associated" name="googleshopping_category_associated"}
                                    {if $LOOP_COUNT === 1}
                                        <thead>
                                        <tr>
                                            <th>{intl l="Thelia category Id"}</th>
                                            <th>{intl l="Thelia category Title"}</th>
                                            <th>{intl l="Associated Google category"}</th>
                                        </tr>
                                        </thead>
                                    {/if}
                                        <tbody>
                                        <tr>
                                            <td>
                                                {$THELIA_CATEGORY_ID}
                                            </td>
                                            <td>
                                                {$THELIA_CATEGORY_TITLE}
                                            </td>
                                            <td>
                                                {$GOOGLE_CATEGORY}
                                            </td>
                                        </tr>
                                        </tbody>
                                    {/loop}
                                    {elseloop rel="googleshopping_category_associated"}
                                        <tbody>
                                        <tr>
                                            <td>
                                                <p class="alert alert-info" role="alert">
                                                    {intl l="No associated category"}
                                                </p>
                                            </td>
                                        </tr>
                                        </tbody>
                                    {/elseloop}
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="management" class="tab-pane {if $tab eq "management"}active{/if} form-container">
                    <div class="panel panel-default">
                        <div class="panel-heading clearfix">
                            {include
                            file      = "includes/inner-form-toolbar.html"
                            hide_save_and_close_button = true
                            hide_save_buttons = true
                            hide_submit_buttons = true
                            }
                        </div>
                        <div class="panel-body">
                            {if 'none' === $tokenExist}
                            <div class="form-group col-md-12">
                                <div class="form-group col-md-7">
                                    {intl l="You have to authorise this site on GoogleShopping before adding products :"}
                                </div>
                                <div class="form-group col-md-3">
                                    <form action="{url path='/googleshopping/oauth2callback'}" method="get">
                                        <input type="hidden" name="redirect" value="{url path={navigate to="current"} current_tab="management"}" />
                                        <button class="btn btn-default btn-primary form-control" type="submit">
                                            <span class="glyphicon glyphicon-check"></span>
                                            {intl l="Authorize"}
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {elseif true === $tokenExpired}
                            <div class="form-group col-md-12">
                                <div class="form-group col-md-7">
                                    {intl l="Your authorisation expired please refresh it before adding products :"}
                                </div>
                                <div class="form-group col-md-3">
                                    <form action="{url path='/googleshopping/oauth2callback'}" method="get">
                                        <input type="hidden" name="redirect" value="{url path={navigate to="current"} current_tab="management"}" />
                                        <button class="btn btn-default btn-primary form-control" type="submit">
                                            <span class="glyphicon glyphicon-check"></span>
                                            {intl l="Refresh"}
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {else}
                            {*<form action="{url path="/admin/module/googleshopping/add/products"}" method="get">*}
                                <div class="panel-group js-product-accordion js-product active">
                                    {loop type="category" name="category" visible="*"}
                                        {$categoryId = $ID}
                                        {ifloop rel="googleshopping_category_associated_management"}
                                            {loop type="googleshopping.category.associated" name="googleshopping_category_associated_management" category_id={$categoryId}}
                                            {/loop}
                                            <div class="panel panel-default">
                                                <div class="panel-heading js-hash-product-category-{$categoryId}">
                                                    <h4 class="panel-title">
                                                        <a data-toggle="collapse" data-parent=".js-product-accordion" href="#product-category-{$categoryId}">
                                                            {$TITLE}
                                                        </a>
                                                    </h4>
                                                </div>
                                                <div id="product-category-{$ID}" class="panel-collapse collapse {if $curr_cat == $categoryId}in{/if}">
                                                    <div class="panel-body">
                                                        <table class="table table-striped table-condensed table-left-aligned">
                                                            <thead>
                                                            <tr>
                                                                <th class="object-title">
                                                                    {admin_sortable_header
                                                                        current_order=$smarty.get.product_order
                                                                        order='id'
                                                                        reverse_order='id_reverse'
                                                                        path={url path={navigate to="current"} current_tab="management" current_cat=$categoryId}
                                                                        request_parameter_name='product_order'
                                                                        label={intl l='ID'}
                                                                    }
                                                                </th>

                                                                <th class="object-title">
                                                                    {admin_sortable_header
                                                                        current_order=$smarty.get.product_order
                                                                        order='ref'
                                                                        reverse_order='ref_reverse'
                                                                        path={url path={navigate to="current"} current_tab="management" current_cat=$categoryId}
                                                                        request_parameter_name='product_order'
                                                                        label={intl l='Ref'}
                                                                    }
                                                                </th>

                                                                <th class="object-title">
                                                                    {admin_sortable_header
                                                                        current_order=$smarty.get.product_order
                                                                        order='ean'
                                                                        reverse_order='ean_reverse'
                                                                        path={url path={navigate to="current"} current_tab="management" current_cat=$categoryId}
                                                                        request_parameter_name='product_order'
                                                                        label={intl l='GTIN'}
                                                                    }
                                                                    <input class="check-all-gtin" data-category="{$categoryId}" type="checkbox"/>
                                                                </th>

                                                                <th class="object-title">
                                                                    {admin_sortable_header
                                                                    current_order=$smarty.get.product_order
                                                                    order='alpha'
                                                                    reverse_order='alpha_reverse'
                                                                    path={url path={navigate to="current"} current_tab="management" current_cat=$categoryId}
                                                                    request_parameter_name='product_order'
                                                                    label={intl l='Title'}
                                                                    }
                                                                </th>

                                                                <th>{intl l="Check all "}<input class="check-all-product" data-category="{$categoryId}" type="checkbox"/></th>
                                                                <th>
                                                                    <button class="send-checked btn btn-default btn-success btn-sm form-control" data-category="{$categoryId}" class="btn btn-default btn-success btn-xs form-control" type="submit">
                                                                        {intl l="Send checked"}
                                                                    </button>
                                                                </th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            {loop type="googleshopping.product" name="googleshopping_product" category_id={$categoryId} product_order=$smarty.get.product_order}
                                                                <form id="form-product-{$ID}" action="/admin/module/googleshopping/add/{$ID}" method="get">
                                                                    <input type="hidden" name="locale" value="{$edit_language_locale}">
                                                                    <input type="hidden" name="ajax" value="true">

                                                                    <tr {if $EXIST == 1}class="success"{/if}>
                                                                    <td>{$ID}</td>
                                                                    <td><a href="{url path="/admin/products/update?product_id=%product_id" product_id=$ID}">{$REF}</a></td>
                                                                    <td>{if $VALID_EAN === false}
                                                                            {intl l="Error At least one GTIN is empty."}
                                                                            <br/><input class="check-gtin-{$categoryId}" id="gtin-product-{$ID}" type="checkbox" name="gtin" /> {intl l="This product don't have GTIN."}
                                                                        {else}
                                                                            {intl l="GTIN ok"}
                                                                        {/if}
                                                                    </td>
                                                                    <td>{$TITLE}</td>
                                                                    {if $EXIST == 1}
                                                                        <td colspan="2">
                                                                            {intl l="Product already sent"}
                                                                        </td>
                                                                    {else}
                                                                        <td id="td-product-{$ID}"><input class="check-product-{$categoryId}" type="checkbox" data-product="{$ID}" name="products[{$ID}][checkbox]"/></td>
                                                                        <td>
                                                                            <button class="btn btn-default btn-primary btn-sm form-control" type="submit">
                                                                                {intl l="Send"}
                                                                            </button>
                                                                        </td>
                                                                    {/if}
                                                                    </tr>
                                                                </form>
                                                            {/loop}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        {/ifloop}
                                        {elseloop rel="googleshopping_category_associated_management"}
                                            <div class="panel panel-warning">
                                                <div class="panel-heading js-hash-product-category-{$categoryId}">
                                                    <h4 class="panel-title">
                                                        <a data-toggle="collapse" data-parent=".js-product-accordion" href="#product-category-{$categoryId}">
                                                            {$TITLE}
                                                        </a>
                                                    </h4>
                                                    <p>{intl l="Warning : this category is not associate with a Google's category, you can't send products in this category."}</p>
                                                </div>
                                            </div>
                                        {/elseloop}
                                    {/loop}
                                </div>
                            {*</form>*}
                            {/if}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>